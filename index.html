<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Routine OS">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/styles.css">
    <title>Routine OS</title>
</head>
<body>
    <header class="header">
        <div class="header-inner">
            <div class="header-left">
                <div>
                    <h1 id="contextTitle">Calendar</h1>
                    <div class="sub" id="contextSubtitle">Today</div>
                </div>
            </div>
            <button class="icon-btn context-switcher" id="contextSwitcher" onclick="cycleContext()" aria-label="Switch context">
                <svg id="contextIcon" viewBox="0 0 24 24" fill="none"></svg>
            </button>
        </div>
    </header>

    <main class="main">
        <!-- Calendar View -->
        <div id="calendarView" class="view-container active">
            <section class="section">
                <div class="cal-header">
                    <h2 class="section-title" id="currentMonth" style="margin:0">Loading...</h2>
                    <div class="cal-nav">
                        <button class="cal-btn" onclick="previousMonth()">&#8249;</button>
                        <button class="cal-btn" onclick="nextMonth()">&#8250;</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendar"></div>
            </section>
            <section class="section">
                <h2 class="section-title">Events for <span id="eventsDate">Today</span></h2>
                <div class="card">
                    <div class="events-list" id="eventsList">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><polyline points="12 6 12 12 16 14" stroke="currentColor" stroke-width="2"/></svg>
                            <p>No events for this day</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Tasks View -->
        <div id="tasksView" class="view-container">
            <section class="section">
                <h2 class="section-title">Daily Tasks</h2>
                <div class="card">
                    <div id="tasksList">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none"><path d="M9 11l3 3L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            <p>No tasks for today</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Coach View -->
        <div id="coachView" class="view-container">
            <section class="section">
                <h2 class="section-title">The Coach</h2>
                <div class="coach-section">
                    <div class="coach-header">
                        <div class="coach-label">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M14.5 17.5L3 6V3h3l11.5 11.5M13 7l4-4 4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            The Coach
                        </div>
                        <span class="coach-status" id="coachStatus">Active</span>
                    </div>
                    <div class="coach-log" id="coachLog"></div>
                    <div class="coach-quick">
                        <button class="coach-quick-btn" onclick="coachCommand('review progress')">Progress</button>
                        <button class="coach-quick-btn" onclick="coachCommand('recommend')">Recommend</button>
                        <button class="coach-quick-btn" onclick="coachCommand('motivate me')">Motivate</button>
                        <button class="coach-quick-btn" onclick="coachCommand('export')">Export</button>
                        <button class="coach-quick-btn" onclick="coachCommand('import')">Import</button>
                    </div>
                    <div class="coach-input-row">
                        <input type="text" class="coach-input" id="coachInput" placeholder="Command the Coach...">
                        <button class="coach-mic" id="coachMic" onclick="toggleVoiceInput()" title="Voice input">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="9" y="2" width="6" height="12" rx="3" stroke="currentColor" stroke-width="2"/><path d="M5 10v2a7 7 0 0 0 14 0v-2" stroke="currentColor" stroke-width="2"/><line x1="12" y1="19" x2="12" y2="22" stroke="currentColor" stroke-width="2"/><line x1="8" y1="22" x2="16" y2="22" stroke="currentColor" stroke-width="2"/></svg>
                        </button>
                        <button class="coach-send" onclick="sendCoachCommand()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><line x1="22" y1="2" x2="11" y2="13" stroke="currentColor" stroke-width="2"/><polygon points="22 2 15 22 11 13 2 9 22 2" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                        </button>
                    </div>
                </div>
            </section>
            <section class="section">
                <h2 class="section-title">Quiet Mode</h2>
                <div class="card">
                    <div class="setting-row">
                        <div>
                            <div style="font-size:13px;font-weight:600;">Notifications</div>
                            <div style="font-size:11px;color:#9ca3af;">Allow system notifications</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="settingNotifications" onchange="toggleSetting('notifications', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-row">
                        <div>
                            <div style="font-size:13px;font-weight:600;">Alarms</div>
                            <div style="font-size:11px;color:#9ca3af;">Allow alarm sound</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="settingAlarms" onchange="toggleSetting('alarms', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Feedback Banner -->
    <div class="feedback-banner" id="feedbackBanner" onclick="dismissFeedback()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M14.5 17.5L3 6V3h3l11.5 11.5M13 7l4-4 4 4-4 4" stroke="#f87171" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span id="feedbackBannerText">The Coach has words for you.</span>
    </div>

    <!-- Context-Aware FAB -->
    <button class="fab" id="contextFab" onclick="handleFabClick()" aria-label="Add">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2"/>
            <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2"/>
        </svg>
    </button>

    <!-- Add Event Modal -->
    <div class="overlay" id="addModal">
        <div class="modal">
            <div class="modal-head">
                <h2>Add Event</h2>
                <button class="close" onclick="closeAll()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2"/><line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2"/></svg></button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <div class="fg"><label class="fl">Title *</label><input class="fi" id="eventTitle" placeholder="Enter title" required></div>
                    <div class="fg"><label class="fl">Description</label><textarea class="ft" id="eventDesc" placeholder="Optional"></textarea></div>
                    <div class="fg"><label class="fl">Date</label><input type="date" class="fi" id="eventDate"></div>
                    <div class="fg"><label class="fl">Time</label><input type="time" class="fi" id="eventTime"></div>
                    <div class="fg">
                        <label class="fl">Alarm Sound</label>
                        <div class="setting-row" style="border:none;padding:6px 0">
                            <div style="display:flex;align-items:center;gap:10px">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="color:#a855f7;flex-shrink:0"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M13.73 21a2 2 0 0 1-3.46 0" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                <span style="font-size:13px;color:#d1d5db">Play alarm sound</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="eventAlarmToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="fg"><label class="fl">Type</label>
                        <div class="type-grid">
                            <button type="button" class="tbtn on" data-type="onetime" onclick="pickEventType(this)">One-time</button>
                            <button type="button" class="tbtn" data-type="recurring" onclick="pickEventType(this)">Daily</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-foot">
                <button class="fbtn fbtn-c" onclick="closeAll()">Cancel</button>
                <button class="fbtn fbtn-s" onclick="saveEvent()">Add Event</button>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="overlay" id="taskModal">
        <div class="modal">
            <div class="modal-head">
                <h2>Add Task</h2>
                <button class="close" onclick="closeAll()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2"/><line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2"/></svg></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <div class="fg">
                        <label class="fl">Task Title *</label>
                        <input class="fi" id="taskTitle" placeholder="What needs to be done?" required>
                    </div>
                    <div class="fg">
                        <label class="fl">Description (Optional)</label>
                        <textarea class="ft" id="taskDesc" placeholder="Add details..." rows="3"></textarea>
                    </div>
                    <div class="fg">
                        <label class="fl">Task Type</label>
                        <div class="type-grid">
                            <button type="button" class="tbtn on" data-type="onetime" onclick="pickTaskType(this)">One-time</button>
                            <button type="button" class="tbtn" data-type="recurring" onclick="pickTaskType(this)">Daily</button>
                        </div>
                    </div>
                    <div class="fg">
                        <label class="fl">Trackable</label>
                        <div class="setting-row" style="border:none;padding:6px 0">
                            <div style="display:flex;align-items:center;gap:10px">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="color:#a855f7;flex-shrink:0"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                <span style="font-size:13px;color:#d1d5db">Track progress</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="taskTrackable" onchange="toggleTrackableFields('task')">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div id="taskTrackableFields" style="display:none">
                        <div class="fg">
                            <label class="fl">Target</label>
                            <div style="display:flex;gap:8px">
                                <input type="number" class="fi" id="taskTarget" placeholder="e.g. 2000" min="1" style="flex:2">
                                <input type="text" class="fi" id="taskUnit" placeholder="ml, min, reps..." style="flex:1">
                            </div>
                        </div>
                        <div class="fg">
                            <label class="fl">Increment per tap</label>
                            <input type="number" class="fi" id="taskIncrement" placeholder="e.g. 250" min="1">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-foot">
                <button class="fbtn fbtn-c" onclick="closeAll()">Cancel</button>
                <button class="fbtn fbtn-s" onclick="saveTask()">Add Task</button>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div class="overlay" id="editTaskModal">
        <div class="modal">
            <div class="modal-head">
                <h2>Edit Task</h2>
                <button class="close" onclick="closeAll()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2"/><line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2"/></svg></button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <div class="fg">
                        <label class="fl">Task Title *</label>
                        <input class="fi" id="editTaskTitle" placeholder="Task title" required>
                    </div>
                    <div class="fg">
                        <label class="fl">Description (Optional)</label>
                        <textarea class="ft" id="editTaskDesc" placeholder="Add details..." rows="3"></textarea>
                    </div>
                    <div class="fg">
                        <label class="fl">Task Type</label>
                        <div class="type-grid">
                            <button type="button" class="tbtn on" data-type="onetime" onclick="pickEditTaskType(this)">One-time</button>
                            <button type="button" class="tbtn" data-type="recurring" onclick="pickEditTaskType(this)">Daily</button>
                        </div>
                    </div>
                    <div class="fg">
                        <label class="fl">Trackable</label>
                        <div class="setting-row" style="border:none;padding:6px 0">
                            <div style="display:flex;align-items:center;gap:10px">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="color:#a855f7;flex-shrink:0"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                <span style="font-size:13px;color:#d1d5db">Track progress</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="editTaskTrackable" onchange="toggleTrackableFields('editTask')">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div id="editTaskTrackableFields" style="display:none">
                        <div class="fg">
                            <label class="fl">Target</label>
                            <div style="display:flex;gap:8px">
                                <input type="number" class="fi" id="editTaskTarget" placeholder="e.g. 2000" min="1" style="flex:2">
                                <input type="text" class="fi" id="editTaskUnit" placeholder="ml, min, reps..." style="flex:1">
                            </div>
                        </div>
                        <div class="fg">
                            <label class="fl">Increment per tap</label>
                            <input type="number" class="fi" id="editTaskIncrement" placeholder="e.g. 250" min="1">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-foot">
                <button class="fbtn fbtn-c" onclick="closeAll()">Cancel</button>
                <button class="fbtn fbtn-s" onclick="saveEditTask()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Scripts loaded in dependency order -->
    <script src="js/state.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/alarms.js"></script>
    <script src="js/calendar.js"></script>
    <script src="js/tasks.js"></script>
    <script src="js/coach.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
